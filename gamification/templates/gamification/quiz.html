{% extends "base.html" %}
{% load i18n %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">üß† {% trans "Financial Inclusion Quiz" %}</h2>

  {% if submitted %}
    <div class="text-center mb-4">
      <h4>{% trans "Your Score" %}: {{ score }}/{{ total }} ({{ percentage }}%)</h4>
      {% if badge %}
        <div class="alert alert-success">
          üèÖ {% trans "You earned a" %} <strong>{{ badge }}</strong> {% trans "badge!" %}
        </div>
      {% else %}
        <div class="alert alert-warning">
          ‚ùó {% trans "Keep learning and try again for a badge!" %}
        </div>
      {% endif %}
    </div>

    {% for f in feedback %}
      <div class="card mb-3">
        <div class="card-header 'bg-success text-white'">
          <strong>Q{{ forloop.counter }}:</strong> {{ f.question }}
        </div>
        <div class="card-body">
          <p><strong>{% trans "Your Answer" %}:</strong> {{ f.your_answer }}</p>
          <p><strong>{% trans "Correct?" %}:</strong> {{ f.correct|yesno:_("Yes,No") }}</p>
          <p><strong>{% trans "Explanation" %}:</strong> {{ f.explanation }}</p>
        </div>
      </div>
    {% endfor %}

    <div class="text-center mt-4">
      <a href="{% url 'financial_quiz' %}" class="btn btn-primary">
        üîÅ {% trans "Try Again" %}
      </a>
    </div>
  {% else %}
    <form method="post" id="quiz-form">
      {% csrf_token %}
      {% for q in quiz_questions %}
        <div class="mb-4 p-3 border rounded shadow-sm">
          <p><strong>Q{{ forloop.counter }}:</strong> {{ q.question }}</p>
          {% for opt in q.options %}
            <div class="form-check">
              <input class="form-check-input" type="radio" name="answer_{{ forloop.parentloop.counter0 }}"
                     id="opt_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}"
                     value="{{ opt }}">
              <label class="form-check-label" for="opt_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}">
                {{ opt }}
              </label>
            </div>
          {% endfor %}
        </div>
      {% endfor %}

      <div class="d-grid mt-4">
        <button type="submit" class="btn btn-success btn-lg">‚úÖ {% trans "Submit Answers" %}</button>
      </div>
    </form>

    <script>
      document.getElementById("quiz-form").addEventListener("submit", function(e) {
        const totalQuestions = {{ quiz_questions|length }};
        let allAnswered = true;

        for (let i = 0; i < totalQuestions; i++) {
          const options = document.getElementsByName("answer_" + i);
          let answered = false;
          for (const opt of options) {
            if (opt.checked) {
              answered = true;
              break;
            }
          }
          if (!answered) {
            allAnswered = false;
            break;
          }
        }

        if (!allAnswered) {
          e.preventDefault();
          alert("{% trans 'Please answer all questions before submitting.' %}");
        }
      });
    </script>
  {% endif %}
</div>
{% endblock %}
