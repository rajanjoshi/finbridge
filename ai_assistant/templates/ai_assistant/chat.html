{% extends "base.html" %}
{% load markdown_extras %}
{% block content %}
<div class="container">
  {% if user.is_authenticated %}
    <h2>ğŸ¤– AI Financial Assistant</h2>

    <div class="mt-3">
      <button id="start-record" class="btn btn-warning">ğŸ¤ Speak to ask question</button>
      <div id="mic-animation" style="display:none; margin-top: 10px;">
        <div class="spinner-grow text-danger" role="status"></div>
        <small>Listening...</small>
      </div>
      <small class="text-muted d-block mt-1">You can speak in the selected language (e.g. Hindi, Marathi).</small>
    </div>

    <form method="post" enctype="multipart/form-data" id="chat-form">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" class="btn btn-success">Ask</button>
    </form>

    {% if chat_history %}
      <div class="mt-4">
        <h5>ğŸ—‚ï¸ Chat History</h5>
        {% for chat in chat_history %}
          <div class="response mb-3">
            <div class="card-header bg-info text-white">
              Question: {{ chat.question }}
            </div>
            <div class="card-body" style="font-family: 'Segoe UI', sans-serif; font-size: 1rem;">
              Answer: {{ chat.answer }}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    
    <div id="loading-spinner" class="text-center mt-4" style="display: none;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Generating your personalized response...</p>
    </div>

    {% if response %}
      <div class="card mt-4 shadow-sm border-info">
        <div class="card-header bg-info text-white">
          {{ "ğŸ’¡ Response from AI Assistant" }}
        </div>
        <div class="card-body" style="font-family: 'Segoe UI', sans-serif; font-size: 1rem;">
          {{ response|render_markdown|safe }}
        </div>        
      </div>
    {% endif %}

    {% if audio_base64 %}
      <audio id="tts-audio" controls autoplay class="mt-3">
        <source src="data:audio/mp3;base64,{{ audio_base64 }}" type="audio/mp3">
        Your browser does not support audio playback.
      </audio>
      <button id="stop-audio" class="btn btn-danger btn-sm mt-2">ğŸ”‡ Stop Audio</button>
    {% endif %}


    {% if error %}
      <p class="error mt-3">{{ error }}</p>
    {% endif %}

    <form method="post" action="{% url 'clear_chat_history' %}">
      {% csrf_token %}
      <button type="submit" class="btn btn-outline-danger mt-4">ğŸ§¹ Clear Chat History</button>
    </form>
    {% else %}

    <div class="login-cta">
      ğŸ” Please <a href="/login/">login</a> to use the AI Assistant.
    </div>
  {% endif %}
</div>

<script>
  let mediaRecorder;
  let audioChunks = [];

  const startBtn = document.getElementById("start-record");
  const form = document.getElementById("chat-form");
  const spinner = document.getElementById("loading-spinner");
  const micAnim = document.getElementById("mic-animation");

  startBtn.onclick = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream, {
      mimeType: 'audio/webm;codecs=opus'
    });
    audioChunks = [];

    mediaRecorder.ondataavailable = e => {
      audioChunks.push(e.data);
    };

    mediaRecorder.onstop = async () => {
      micAnim.style.display = "none";
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      const formData = new FormData(form);
      formData.append('audio', audioBlob, 'speech.webm');

      spinner.style.display = 'block';

      const response = await fetch("{% url 'chat_view' %}", {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      });

      const html = await response.text();
      document.open(); document.write(html); document.close();
    };

    mediaRecorder.start();
    micAnim.style.display = "block";

    // Automatically stop after 8 seconds (can be adjusted)
    setTimeout(() => {
      mediaRecorder.stop();
    }, 8000);
  };

  form.addEventListener("submit", () => {
    spinner.style.display = "block";
  });

  const audio = document.getElementById("tts-audio");
  const stopBtn = document.getElementById("stop-audio");

  if (audio && stopBtn) {
    stopBtn.onclick = () => {
      audio.pause();
      audio.currentTime = 0;
    };
  }  
</script>
{% endblock %}
